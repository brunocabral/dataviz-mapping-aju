<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="./css/mapping-aju.css" type="text/css" >
</head>

<body>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js"></script>
  <script src="https://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script type="text/javascript">
    
    //====================  JSON  DATA ==================================================

    // stations input data
    var stationData = [{
        "id": 0,
        "nome": "Sao Cristovão",
        "x": "50",
        "y": "900"
      },
      {
        "id": 1,
        "nome": "Campus",
        "x": "100",
        "y": "700"
      },
      {
        "id": 2,
        "nome": "Zona Oeste",
        "x": "100",
        "y": "400"
      },
      {
        "id": 3,
        "nome": "Maracaju",
        "x": "100",
        "y": "150"
      },
      {
        "id": 4,
        "nome": "Marcos Freire",
        "x": "450",
        "y": "30"
      },
      {
        "id": 5,
        "nome": "Barra",
        "x": "820",
        "y": "480"
      },
      {
        "id": 6,
        "nome": "Mercado",
        "x": "550",
        "y": "300"
      },
      {
        "id": 7,
        "nome": "Luiz Garcia",
        "x": "450",
        "y": "390"
      },
      {
        "id": 8,
        "nome": "Centro",
        "x": "550",
        "y": "630"
      },
      {
        "id": 9,
        "nome": "DIA",
        "x": "300",
        "y": "850"
      },
      {
        "id": 10,
        "nome": "Zona Sul",
        "x": "680",
        "y": "990"
      }
    ];

    // //bus lines input data
    var busRouteData = [{
      "numeracao": "101",
      "nome": "Parque São José / Maracaju",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }]
    }, {
      "numeracao": "102",
      "nome": "Soledade / Maracaju",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }]
    }, {
      "numeracao": "104",
      "nome": "Pousada Verde / Maracaju",
      "tipo": "Linha Urbana",
      "terminais": []
    }, {
      "numeracao": "301",
      "nome": "Luiz Alves / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }]
    }, {
      "numeracao": "302",
      "nome": "Conjunto Jardim / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "305",
      "nome": "Parque dos Faróis / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "306",
      "nome": "Guajará / Palestina / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "307",
      "nome": "São Cristóvão / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 0
      }, {
        "id": 1
      }, {
        "id": 2
      }]
    }, {
      "numeracao": "308",
      "nome": "Sobrado / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "309",
      "nome": "Centro Administrativo / Zona Oeste",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "310",
      "nome": "Terminal Rodoviário / Shopping Riomar",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }]
    }, {
      "numeracao": "311",
      "nome": "Rita Cacete / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }]
    }, {
      "numeracao": "312",
      "nome": "Pedreira / Zona Oeste",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }]
    }, {
      "numeracao": "801",
      "nome": "Luiz Alves / Campus",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }]
    }, {
      "numeracao": "401",
      "nome": "Inácio Barbosa / Unit / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "403",
      "nome": "Santa Maria / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "405",
      "nome": "17 de Março / DIA via Aquarius",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "406",
      "nome": "Aloque / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "407",
      "nome": "Padre Pedro / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "408_1",
      "nome": "Paraíso Sul / DIA 01",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "409",
      "nome": "Riomar / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "410",
      "nome": "Inácio Barbosa / Jardins / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "411",
      "nome": "Inácio Barbosa / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "501",
      "nome": "Povoado São José / Zona Sul",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "502",
      "nome": "Santa Tereza / Zona Sul",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "503",
      "nome": "Conjunto Beira Mar / Zona Sul",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "504",
      "nome": "17 de Março / Zona Sul via Aquarius",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "505",
      "nome": "Santa Maria / Zona Sul",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "604",
      "nome": "Terminal Rodoviário / Maranhão",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "605",
      "nome": "18 do Forte / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "606",
      "nome": "Parque São José / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }]
    }, {
      "numeracao": "607",
      "nome": "Santos Dumont / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "610",
      "nome": "São Carlos / Centro",
      "tipo": "Linha Urbana",
      "terminais": []
    }, {
      "numeracao": "612",
      "nome": "São Carlos / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }]
    }, {
      "numeracao": "613",
      "nome": "Bairro Industrial / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }]
    }, {
      "numeracao": "614",
      "nome": "Getimana / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "615",
      "nome": "Bugio / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "701",
      "nome": "Jardim Atlântico / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "702",
      "nome": "Augusto Franco / Beira Mar",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "703",
      "nome": "Augusto Franco / Siqueira Campos",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "704",
      "nome": "Conjunto Jardim / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "705",
      "nome": "Parque dos Faróis / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "706",
      "nome": "Santa Lúcia / Centro via Suíssa",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "707",
      "nome": "Castelo Branco / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }]
    }, {
      "numeracao": "708",
      "nome": "Bairro América / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "709",
      "nome": "DIA / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "710",
      "nome": "DER / Veneza",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }]
    }, {
      "numeracao": "711",
      "nome": "Sol Nascente / Nova Saneamento",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "712",
      "nome": "Quissamã / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 6
      }]
    }, {
      "numeracao": "713",
      "nome": "São Cristóvão / Palestina / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 0
      }, {
        "id": 7
      }]
    }, {
      "numeracao": "714",
      "nome": "Quissamã / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "715",
      "nome": "Tijuquinha / Des. Maynard",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "716",
      "nome": "Socorro / Br / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "717",
      "nome": "Mosqueiro / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "718",
      "nome": "Guajará / Palestina / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "719",
      "nome": "Sobrado / Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 7
      }]
    }, {
      "numeracao": "721",
      "nome": "Castelo Branco / Suissa",
      "tipo": "Linha Urbana",
      "terminais": []
    }, {
      "numeracao": "722",
      "nome": "Estiva / Mercado Via Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 6
      }]
    }, {
      "numeracao": "723",
      "nome": "Caípe Novo / Centro",
      "tipo": "Linha Urbana",
      "terminais": []
    }, {
      "numeracao": "901",
      "nome": "Socorro / Terminal Marcos Freire",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }]
    }, {
      "numeracao": "902",
      "nome": "São Braz / Terminal Marcos Freire / Maria do Carmo",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }]
    }, {
      "numeracao": "001",
      "nome": "Augusto Franco / Bugio",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "002",
      "nome": "Fernando Collor / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 6
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "003",
      "nome": "João Alves / Orlando Dantas",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 6
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "004",
      "nome": "Santa Maria / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "005",
      "nome": "Maracaju / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 6
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "006",
      "nome": "Sanatório / DIA",
      "tipo": "Linha Urbana",
      "terminais": []
    }, {
      "numeracao": "007",
      "nome": "Fernando Collor / Atalaia",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "008",
      "nome": "Santa Tereza / Bairro Industrial",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 6
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "020",
      "nome": "Piabeta /DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 4
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "030",
      "nome": "Marcos Freire I e III / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }, {
        "id": 3
      }]
    }, {
      "numeracao": "031",
      "nome": "Eduardo Gomes / Desembargador Maynard",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "033",
      "nome": "Terminal Rodoviário / Desembargador Maynard",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "034",
      "nome": "Terminal Rodoviário / Lourival Batista",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "035",
      "nome": "Terminal Rodoviário / Nova Saneamento",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "040",
      "nome": "Marcos Freire II / DIA",
      "tipo": "Linha Suburbana",
      "terminais": [{
        "id": 9
      }, {
        "id": 2
      }, {
        "id": 3
      }, {
        "id": 4
      }]
    }, {
      "numeracao": "040A",
      "nome": "Marcos Freire II / Atalaia",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 3
      }, {
        "id": 9
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "050",
      "nome": "Campus / Hospital Universitário",
      "tipo": "Linha Suburbana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }, {
        "id": 3
      }]
    }, {
      "numeracao": "051",
      "nome": "Atalaia / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "060",
      "nome": "Padre Pedro / Campus",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "061",
      "nome": "Marcos Freire / Centro",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "062",
      "nome": "Piabeta / Centro",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "062B",
      "nome": "Piabeta / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "063",
      "nome": "Albano Franco / Centro / Via Osvaldo Aranha",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 3
      }, {
        "id": 4
      }, {
        "id": 7
      }]
    }, {
      "numeracao": "064",
      "nome": "Albano Franco / Centro / Via Porto Dantas",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "070",
      "nome": "Santa Maria / Campus",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "071",
      "nome": "Atalaia Nova / Centro",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "072",
      "nome": "Barra dos Coqueiros / Centro",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "073",
      "nome": "Atalaia Nova / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "074",
      "nome": "Unit / Centro",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 8
      }]
    }, {
      "numeracao": "080",
      "nome": "Bugio / Atalaia",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 9
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "100_CS1",
      "nome": "Circular Shoppings 01",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "100_CS2",
      "nome": "Circular Shoppings 02",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "200_CIC1",
      "nome": "Circular Indústria e Comércio 01",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "200_CIC2",
      "nome": "Circular Indústria e Comércio 02",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 3
      }, {
        "id": 6
      }, {
        "id": 8
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "402_1",
      "nome": "Santa Lúcia / DIA 01",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "402_2",
      "nome": "Santa Lúcia / DIA 02",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "402_3",
      "nome": "Santa Lúcia / DIA 03",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "411B",
      "nome": "Inácio Barbosa / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "600 CP1",
      "nome": "Circular Praias 01",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "600 CP2",
      "nome": "Circular Praias 02",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "009",
      "nome": "Terminal Marcos Freire / Atalaia",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 4
      }, {
        "id": 6
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "413",
      "nome": "Aquarius / DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "065B",
      "nome": "Marcos Freire II / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 6
      }]
    }, {
      "numeracao": "065",
      "nome": "Marcos Freire II / Centro",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 6
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "412",
      "nome": "Circular DIA",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }, {
        "id": 10
      }]
    }, {
      "numeracao": "408_2",
      "nome": "Paraíso Sul / DIA 02",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "506",
      "nome": "17 de Março / Zona Sul via Aeroporto",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 10
      }]
    }, {
      "numeracao": "010",
      "nome": "DIA / Zona Oeste",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 2
      }, {
        "id": 9
      }]
    }, {
      "numeracao": "404",
      "nome": "Caípe Novo / DIA",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 9
      }]
    }, {
      "numeracao": "076",
      "nome": "Barra dos Coqueiros / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "603",
      "nome": "Orlinha / Mercado",
      "tipo": "Linha Urbana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "075",
      "nome": "Litoral  Norte / Mercado",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 5
      }, {
        "id": 6
      }]
    }, {
      "numeracao": "032_1",
      "nome": "Tijuquinha / Osvaldo Aranha 01",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "032_2",
      "nome": "Tijuquinha / Osvaldo Aranha 02",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 1
      }, {
        "id": 2
      }, {
        "id": 8
      }]
    }, {
      "numeracao": "103",
      "nome": "Conjunto Maria do Carmo / Maracaju",
      "tipo": "Linha Metropolitana",
      "terminais": [{
        "id": 3
      }]
    }]

    //=========== Standardizing and preparing input data for dataviz ====================

    var STATIONS = [];
    var LINKS = [];

    //== NODES - Initiate input data of Bus Stations
    function initStationData() {
      var stations = []; //temp
      for (var i = 0; i < stationData.length; i++) {
        //transforms a JSON object into a Station object
        var station = new Station(
          stationData[i]["id"],
          stationData[i]["nome"],
          stationData[i]["x"],
          stationData[i]["y"]);
        stations.push(station);
      }
      return stations;
    }

    STATIONS = initStationData();

    //== LINKS - Initiate input data of Bus Lines routes links (connections) ============
    function initLinkData() {
      var links = []; //temp 

      for (var i = 0; i < busRouteData.length; i++) {
        var stationsVisited = busRouteData[i].terminais; //Bus Stations in which the Bus Route visits

        if (stationsVisited.length > 1) { // minimum 2 Bus Stations to connections exist
          var color = "rgba(" +
            Math.floor(Math.random() * 255) + "," +
            Math.floor(Math.random() * 200) + "," +
            Math.floor(Math.random() * 255) +
            ", 1)";

          for (var j = 0; j < stationsVisited.length - 1; j++) { //-1 to avoid array out of bounds exception
            var source = stationsVisited[j]; //current station
            var target = stationsVisited[j + 1]; //next station 

            var link = {}; //stores all Bus link info
            link.source = source.id;
            link.target = target.id;
            link.busRouteId = busRouteData[i].numeracao.toString();
            link.busRouteName = busRouteData[i].nome;
            link.color = color;
            links.push(link);
          }
        }
      }
      return links;
    }

    LINKS = initLinkData();

    // console.log(stations)
    // console.log(links);

    //Bus Station Class
    function Station(id, name, x, y) {
      this.id = id;
      this.name = name;
      this.fixed = true; //node position fixed on graph
      this.x = x; //positioning x-axis
      this.y = y; //positioning y-axis    
    }

    // == DATA FORMATING  ===============================================================

    /* 
      MULTIPLE LINKS BETWEEN NODES IN FORCE LAYOUT
      Lodash.js lib.
      code snippet based on  http://bl.ocks.org/thomasdobber/9b78824119136778052f64a967c070e0 
      Thanks to Thomas Dobber 
    */
    _.each(LINKS, function (link) {
      // links with: same target + source or source + target 
      var same = _.where(LINKS, {
        'source': link.source,
        'target': link.target
      });
      var sameInverse = _.where(LINKS, {
        'source': link.target,
        'target': link.source
      });
      var sameAll = same.concat(sameInverse);

      _.each(sameAll, function (s, i) {
        s.sameIndex = (i + 1);
        s.sameTotal = sameAll.length;
        s.sameTotalHalf = (s.sameTotal / 2);
        s.sameUneven = ((s.sameTotal % 2) !== 0);
        s.sameMiddleLink = ((s.sameUneven === true) && (Math.ceil(s.sameTotalHalf) === s.sameIndex));
        s.sameLowerHalf = (s.sameIndex <= s.sameTotalHalf);
        s.sameArcDirection = s.sameLowerHalf ? 0 : 1;
        s.sameIndexCorrected = s.sameLowerHalf ? s.sameIndex : (s.sameIndex - Math.ceil(s.sameTotalHalf));
      });
    });

    var maxSame = _.chain(LINKS)
      .sortBy(function (x) {
        return x.sameTotal;
      })
      .last()
      .value().sameTotal;

    _.each(LINKS, function (link) {
      link.maxSameHalf = Math.floor(maxSame / 3);
    });

    // D3 FORCE  SETTINGS
    var width = 900,
      height = 1035;

    var force = d3.layout.force()
      .nodes(STATIONS)
      .links(LINKS)
      .size([width, height])
      .linkDistance(300)
      .charge(-80)
      .on('tick', tick)
      .start();

    // DRAG function
    var drag = force.drag()
      .on("dragstart", dragged);

    // RENDER - SVG
    var svgContainer = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)

    // TOOLTIP - Bus Route info 
    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    //Paths (Bus Route)
    var path = svgContainer.append("g").selectAll("path")
      .data(force.links())
      .enter().append("path")
      .attr("id", function (d) {
        return d.busRouteId;
      })
      .attr("class", function (d) {
        return "busroute-path " + "busroute-" + d.busRouteId;
      })
      .style("stroke", function (d) {
        return d.color;
      })
      // .on("mouseover", showTooltip)
      .on("mouseover", turnOnGlow)
      // .on("mouseout", hideTooltip)
      .on("mouseout", turnOffGlow)
      .on("click", highlightRoute);

    //Circles (Station Nodes)
    var circle = svgContainer.append("g").selectAll("circle")
      .data(force.nodes())
      .enter().append("circle")
      .attr("r", 10)
      .call(drag)
      .on('dblclick', highlightStations);

    var text = svgContainer.append("g").selectAll("text")
      .data(force.nodes())
      .enter().append("text")
      .attr("x", 8)
      .attr("y", ".31em")
      .text(function (d) {
        return d.name;
      });

    /* GLOWING EFFECT
      thanks to: https://www.visualcinnamon.com/2016/06/glow-filter-d3-visualization.html  
    */
    //Container for the gradients
    var defs = svgContainer.append("defs");

    //Filter for the outside glow
    var filter = defs.append("filter")
      .attr("id", "glow");
    filter.append("feGaussianBlur")
      .attr("stdDeviation", "3.5")
      .attr("result", "coloredBlur");

    var feMerge = filter.append("feMerge");
    feMerge.append("feMergeNode")
      .attr("in", "coloredBlur");
    feMerge.append("feMergeNode")
      .attr("in", "SourceGraphic");

    //Glows bus route when hovered on 
    function turnOnGlow(d, i) {
      var coords = d3.mouse(this);
      svgContainer.selectAll(".busroute-" + this.id)
        .style("filter", "url(#glow)");
    }

    function turnOffGlow() {
      svgContainer.selectAll(".busroute-path")
        .style("filter", "none");
    }

    // TICK Interaction
    function tick(d) {
      circle.attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
      path.attr("d", linkArc);
      text.attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
    }

    // DRAGGED - when node is dragged, its position is fixed
    function dragged(d) {
      d3.select(this).classed("fixed", d.fixed = true);
    }

    // ARC CALCULATION (Between Paths)
    // some more info: http://stackoverflow.com/questions/11368339/drawing-multiple-edges-between-two-nodes-with-d3
    function linkArc(d) {
      var dx = (d.target.x - d.source.x),
        dy = (d.target.y - d.source.y),
        dr = Math.sqrt(dx * dx + dy * dy),
        unevenCorrection = (d.sameUneven ? 0 : 0.3),
        arc = ((dr * d.maxSameHalf) / (d.sameIndexCorrected - unevenCorrection));

      if (d.sameMiddleLink) {
        arc = 0;
      }
      return "M" + d.source.x + "," + d.source.y + "A" + arc + "," + arc + " 0 0," + d.sameArcDirection + " " + d.target
        .x + "," + d.target.y;
    }

    // TOOL TIP - BUS ROUTE
    function showTooltip(d, i) {
      var coords = d3.mouse(this);
      tooltip.transition()
        .duration(200)
        .style("opacity", .9);

      //show tooltip with bus route info
      var link = LINKS.find(i => i.busRouteId === this.id);
      tooltip.html(this.id + " " + link.busRouteName)
        .style("left", (coords[0]) + "px")
        .style("top", (coords[1] - 28) + "px");
    }

    function hideTooltip(d, i) {
      tooltip.transition()
        .duration(300)
        .style("opacity", 0);
    }

    // HIGHTLIGHT ENTIRE BUS ROUTE    
    var toggleRoute = 0; //Toggle stores whether the highlighting is on

    function highlightRoute(d, i) {
      if (toggleRoute == 0) {
        svgContainer.selectAll(".busroute-path")
          .style("opacity", function (d) {
            return 0.1;
          });
        svgContainer.selectAll(".busroute-" + this.id)
          .style("opacity", function (d) {
            return 1;
          });
        toggleRoute = 1
      } else {
        //Reset to default values
        circle.style("opacity", 1);
        path.style("opacity", 1);
        toggleRoute = 0;
      }
    }

    //HIGHLIGHT LINKED NODES (Stations)
    var toggle = 0; //Toggle stores whether the highlighting is on
    var linkedByIndex = {}; //Create an array logging what is connected to what
    for (i = 0; i < force.nodes.length; i++) {
      linkedByIndex[i + "," + i] = 1;
    };

    LINKS.forEach(function (d) {
      linkedByIndex[d.source.index + "," + d.target.index] = 1;
    });

    //Checks if a pair are neighbours
    function neighboring(a, b) {
      return linkedByIndex[a.index + "," + b.index];
    }

    function highlightStations() {
      if (toggle == 0) {
        //Reduce the opacity of all but the neighbouring nodes
        d = d3.select(this).node().__data__;

        path.style("opacity", function (o) {
          return d.index == o.source.index | d.index == o.target.index ? 1 : 0.1;
        });
        //Reduce the op
        toggle = 1;
      } else {
        //Put them back to opacity=1
        circle.style("opacity", 1);
        path.style("opacity", 1);
        toggle = 0;
      }
    }
  </script>

</body>

</html>